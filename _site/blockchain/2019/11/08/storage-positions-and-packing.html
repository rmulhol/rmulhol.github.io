<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Querying Ethereum Storage: Understanding Positions and Packing</title>
    <meta name="description" content="Random thoughts and musings.
">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://rmulhol.github.io/blockchain/2019/11/08/storage-positions-and-packing.html">
    <link href='http://rmulhol.github.io/feed.xml' rel='alternate' type='application/rss+xml'>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-54831551-1', 'auto');
      ga('send', 'pageview');

    </script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Rob Writes Code</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Querying Ethereum Storage: Understanding Positions and Packing</h1>
    <p class="post-meta">Nov 8, 2019</p>
  </header>

  <article class="post-content">
    <p>One advantage of Ethereum’s decentralized applications is their transparency: you don’t have to trust anyone because you can verify everything for yourself.
Unfortunately, it’s not often clear <em>how</em> to perform that verification.</p>

<p>Ethereum nodes assist in this effort by verifying the validity of state transitions, but a “valid” state transition might still yield unexpected results.
In order to verify that the state of the network matches your expectations, you need to be able to perform queries that access that state.</p>

<p>How do you do that?</p>

<p><strong>Querying Storage</strong></p>

<p>The obvious query for accessing contract state is <a href="https://github.com/ethereum/wiki/wiki/JSON-RPC#eth_getstorageat">eth_getStorageAt</a>.
This enables you to lookup the value assigned to any variable on a deployed contract at any block.</p>

<p>Any time you use this query, the first and third arguments are obvious: the contract address and the block number.
You want to access the value of a variable on a given contract at a given block, so plug in that contract’s address and the desired block number (or “latest” for the most recent value).</p>

<p>The tricky part comes in constructing the second argument: the storage key.
<a href="https://solidity.readthedocs.io/en/latest/miscellaneous.html#layout-of-state-variables-in-storage">The Solidity docs</a> cover how to build this key for Solidity contracts, but the devil is in the details.</p>

<p>The first topic to understand in building storage keys for Solidity contracts is variable positioning.</p>

<p><strong>Variable Positions</strong></p>

<p>For contract variables that are neither a mapping nor a dynamic array, the storage key is the zero-indexed position of the variable on the contract.
This means that the first variable usually has a storage key of <code class="language-plaintext highlighter-rouge">0</code>, the second <code class="language-plaintext highlighter-rouge">1</code>, the third <code class="language-plaintext highlighter-rouge">2</code>, and so forth.</p>

<p>The main quirk that can get in the way here is packing.
Variables that do not occupy an entire storage slot (32 bytes) will be packed together if they are ordered contiguously (and both fit in a single slot).</p>

<p>Let’s take a look at an example contract:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">pragma solidity 0.5.12;

contract PackingExample {
    uint256 callCount;
    uint128 numberOne;
    uint128 numberTwo;

    function setNumberOne(uint128 n) public {
        callCount++;
        numberOne = n;
    }

    function setNumberTwo(uint128 n) public {
        callCount++;
        numberTwo = n;
    }
}</code></pre></figure>

<p>There are three variables on this contract, but only two storage slot positions.
Since a <code class="language-plaintext highlighter-rouge">uint128</code> only occupies 16 bytes and we have two of them arranged contiguously following a completely occupied slot, they are packed into the same position: <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>Suppose that we execute two transactions against this contract:</p>
<ol>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberOne(1)</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberTwo(2)</code></li>
</ol>

<p>In that case, we would expect a call to get the latest storage at position <code class="language-plaintext highlighter-rouge">1</code> on this contract to return <code class="language-plaintext highlighter-rouge">0000000000000000000000000000000200000000000000000000000000000001</code>.</p>

<p>Since items in a storage slot are lower-order aligned, the 16 bytes to the right represent the value for <code class="language-plaintext highlighter-rouge">numberOne</code> and the 16 bytes to the left represent <code class="language-plaintext highlighter-rouge">numberTwo</code>.</p>

<p>Let’s take a look at one more example:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">pragma solidity 0.5.12;

contract PackingExampleTwo {
    uint64 callCount;
    uint128 numberOne;
    uint128 numberTwo;
    uint64 numberThree;
    uint64 numberFour;

    function setNumberOne(uint128 n) public {
        callCount++;
        numberOne = n;
    }

    function setNumberTwo(uint128 n) public {
        callCount++;
        numberTwo = n;
    }

    function setNumberThree(uint64 n) public {
        callCount++;
        numberThree = n;
    }

    function setNumberFour(uint64 n) public {
        callCount++;
        numberFour = n;
    }
}</code></pre></figure>

<p>Can you guess how many storage slots this contract uses?
Which variables will go into which position?</p>

<p>This contract also requires only two storage slot positions, but the contiguously arranged <code class="language-plaintext highlighter-rouge">uint128</code> variables do not occupy the same slot.
Instead, position <code class="language-plaintext highlighter-rouge">0</code> contains <code class="language-plaintext highlighter-rouge">callCount</code> and <code class="language-plaintext highlighter-rouge">numberOne</code>, and position <code class="language-plaintext highlighter-rouge">1</code> contains <code class="language-plaintext highlighter-rouge">numberTwo</code>, <code class="language-plaintext highlighter-rouge">numberThree</code>, and <code class="language-plaintext highlighter-rouge">numberFour</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">uint64</code> only requires 8 bytes, which means space remains for <code class="language-plaintext highlighter-rouge">numberOne</code> to be packed into the same slot as <code class="language-plaintext highlighter-rouge">callCount</code>.
At that point, the slot at position <code class="language-plaintext highlighter-rouge">0</code> has utilized 24 of the 32 available bytes, and cannot accommodate the 16 bytes required for <code class="language-plaintext highlighter-rouge">numberTwo</code>.</p>

<p>Instead, <code class="language-plaintext highlighter-rouge">numberTwo</code> occupies 16 bytes in the next position, which also has space to accommodate the two following <code class="language-plaintext highlighter-rouge">uint64</code> values.</p>

<p>Suppose we execute four transactions against this contract:</p>
<ol>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberOne(1)</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberTwo(2)</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberThree(3)</code></li>
  <li>call <code class="language-plaintext highlighter-rouge">setNumberFour(4)</code></li>
</ol>

<p>In that case, we would expect a call to get the latest storage at position <code class="language-plaintext highlighter-rouge">0</code> to return <code class="language-plaintext highlighter-rouge">0000000000000000000000000000000000000000000000010000000000000004</code>, indicating that <code class="language-plaintext highlighter-rouge">callCount</code> is <code class="language-plaintext highlighter-rouge">4</code> and <code class="language-plaintext highlighter-rouge">numberOne</code> is <code class="language-plaintext highlighter-rouge">1</code>.
Note that the first 8 bytes in this storage slot are not used - the first 8 bytes can be discarded when parsing this payload.</p>

<p>Similarly, the latest storage at position <code class="language-plaintext highlighter-rouge">1</code> would be <code class="language-plaintext highlighter-rouge">0000000000000004000000000000000300000000000000000000000000000002</code>, indicating that <code class="language-plaintext highlighter-rouge">numberTwo</code> is <code class="language-plaintext highlighter-rouge">2</code>, <code class="language-plaintext highlighter-rouge">numberThree</code> is <code class="language-plaintext highlighter-rouge">3</code>, and <code class="language-plaintext highlighter-rouge">numberFour</code> is <code class="language-plaintext highlighter-rouge">4</code>.</p>

<p><strong>Further Considerations</strong></p>

<p>Being able to correctly identify the positions of variables on a contract is the first step to correctly building storage keys for desired state.
Hopefully, this post has provided some insight into how to correctly identify the positions of variables given storage packing.</p>

<p>Additional knowledge is required to identify the values for more complex types - entries in mappings and dynamic arrays, structs, etc.
Look forward to future posts on those topics!</p>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Rob Writes Code</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Rob Writes Code</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/rmulhol">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">rmulhol</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/robmulholand">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">robmulholand</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">Random thoughts and musings.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
